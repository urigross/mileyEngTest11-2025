<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jet 2 - ××©×—×§ ×”×›× ×” ×œ××‘×—×Ÿ (×’×¨×¡×” 8 - ××•×ª×× ××•×‘×™×™×œ)</title>
    <style>
        :root {
            --primary: #4a90e2;
            --secondary: #f5a623;
            --success: #7ed321;
            --error: #d0021b;
            --bg: #f0f4f8;
            --card: #ffffff;
            --dark: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 5px; /* ×¤×—×•×ª ×©×•×œ×™×™× ×œ××•×‘×™×™×œ */
            text-align: center;
            direction: rtl;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent; /* ×‘×™×˜×•×œ ×”×‘×”×•×‘ ×‘×œ×—×™×¦×” */
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 10px;
            min-height: 85vh; /* × ×™×¦×•×œ ×’×•×‘×” ××¡×š */
            position: relative;
        }

        h1 { color: var(--primary); margin: 10px 0; font-size: 1.4rem; }
        h2 { color: #555; font-size: 1rem; margin-top: 0; }

        .score-board {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--secondary);
            color: white;
            padding: 4px 10px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .game-screen { display: none; width: 100%; }
        .game-screen.active { display: block; animation: fadeIn 0.5s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 ×¢××•×“×•×ª ×‘××•×‘×™×™×œ */
            gap: 10px;
            padding: 5px;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            font-size: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 3px 0 #357abd;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            width: 100%;
        }

        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-secondary { background: var(--secondary); box-shadow: 0 3px 0 #d48e15; width: auto; display: inline-block; padding: 8px 16px;}
        .btn-info { background: #17a2b8; box-shadow: 0 3px 0 #117a8b; }
        
        .btn-hint { 
            background: #9b59b6; 
            box-shadow: 0 3px 0 #8e44ad; 
            font-size: 0.8rem; 
            padding: 8px 12px; 
            margin-right: 5px;
            display: flex;
            flex-direction: row; 
        }

        /* --- SNAKE GAME STYLES --- */
        #snake-container {
            position: relative;
            width: 100%;
            /* ×”××™×›×œ ××ª××™× ××ª ×¢×¦××• */
            display: flex;
            justify-content: center;
        }
        
        #snake-canvas {
            background-color: #2c3e50;
            border-radius: 10px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            display: block;
            /* ×©×™× ×•×™ ×§×¨×™×˜×™: ×”×§× ×‘×¡ ×™×ª×¤×•×¡ ××ª ×”××§×¡×™××•× ×”××¤×©×¨×™ ××š ×™×©××•×¨ ×¢×œ ×¤×¨×•×¤×•×¨×¦×™×” */
            max-width: 100%; 
            height: auto;
            touch-action: none; /* ×× ×™×¢×ª ×’×œ×™×œ×” ×‘×–××Ÿ ××©×—×§ */
        }
        
        .snake-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            z-index: 5;
        }

        /* --- TIGHTER CONTROLS --- */
        .snake-controls {
            display: grid;
            /* ×”×§×˜× ×• ××ª ×’×•×“×œ ×”×ª× ×›×“×™ ×©×”×›×¤×ª×•×¨×™× ×™×™×’×¢×• ×–×” ×‘×–×” */
            grid-template-columns: repeat(3, 80px); 
            grid-template-rows: repeat(3, 75px);    
            gap: 0px; /* ×‘×™×˜×•×œ ×¨×•×•×—×™× ×œ×—×œ×•×˜×™×Ÿ */
            justify-content: center;
            margin-top: 10px;
            direction: ltr;
            touch-action: manipulation;
        }
        
        .d-pad-btn {
            width: 76px; height: 70px; /* ×›×¤×ª×•×¨×™× ×’×“×•×œ×™× */
            border-radius: 15px; /* ×¤×—×•×ª ×¢×’×•×œ ×›×“×™ ×©×™×™×¨××” ×›××• ×¤××“ */
            background: #e0e0e0; 
            border: 1px solid #ccc;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 3px #999;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
            margin: 2px;
            -webkit-user-select: none;
        }
        
        .d-pad-btn:active { 
            transform: scale(0.95); 
            background: #ccc; 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); 
        }

        .btn-up { grid-column: 2; grid-row: 1; border-radius: 15px 15px 5px 5px; }
        .btn-left { grid-column: 1; grid-row: 2; border-radius: 15px 5px 5px 15px; }
        .btn-right { grid-column: 3; grid-row: 2; border-radius: 5px 15px 15px 5px; }
        .btn-down { grid-column: 2; grid-row: 3; border-radius: 5px 5px 15px 15px; }

        /* ××œ×× ×˜ ××¨×›×–×™ ×¨×™×§ ×œ×™×•×¤×™ */
        .d-pad-center { 
            grid-column: 2; grid-row: 2; 
            background: #d0d0d0; 
            border-radius: 5px;
        }

        #snake-word-target {
            font-size: 1.4rem; letter-spacing: 2px; color: var(--primary);
            font-weight: bold; direction: ltr; margin-bottom: 5px;
            word-wrap: break-word; min-height: 30px;
        }

        /* --- MEMORY GAME --- */
        .memory-grid {
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 6px;
            max-width: 100%; margin: 0 auto;
        }
        .memory-card {
            aspect-ratio: 1; background: var(--primary); border-radius: 8px;
            cursor: pointer; position: relative; transform-style: preserve-3d;
            transition: transform 0.4s;
        }
        .memory-card.flipped { transform: rotateY(180deg); background: white; }
        .memory-card-content, .memory-card-front {
            position: absolute; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            backface-visibility: hidden; font-weight: bold;
        }
        .memory-card-content { transform: rotateY(180deg); font-size: 0.9rem; color: #333; padding: 2px; line-height: 1.1; }
        .memory-card-front { font-size: 1.5rem; color: rgba(255,255,255,0.5); }

        /* Other elements */
        .input-box { font-size: 1.2rem; padding: 8px; border-radius: 8px; border: 2px solid #ccc; width: 60%; text-align: center; }
        .feedback { font-size: 1.1rem; margin-top: 10px; font-weight: bold; min-height: 25px; }
        .feedback.correct { color: var(--success); } .feedback.wrong { color: var(--error); }
        
        #victory-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: none; flex-direction: column; align-items: center;
            justify-content: center; color: white; text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="score-board">× ×™×§×•×“: <span id="currentScore">0</span></div>
    
    <div id="screen-menu" class="game-screen active">
        <h1>ğŸ“ ×”×›× ×” ×œ××‘×—×Ÿ ×‘×× ×’×œ×™×ª - ×“'</h1>
        <h2>Unit 1 - At School</h2>
        <div class="menu-grid">
            <button class="btn" onclick="startGame('listening')"><i>ğŸ‘‚</i>×”×‘× ×ª ×”× ×©××¢</button>
            <button class="btn" onclick="startGame('vocab')"><i>âœï¸</i>×›×ª×™×‘×ª ××™×œ×™×</button>
            <button class="btn" onclick="startGame('sentences')"><i>ğŸ§©</i>××©×¤×˜×™×</button>
            <button class="btn" onclick="startGame('reading')"><i>ğŸ“–</i>×§×¨×™××”</button>
            <button class="btn" style="background-color: #9b59b6; grid-column: span 2;" onclick="startSnakeGame()"><i>ğŸ</i> ×¡× ×™×™×§ ××™×œ×™× (×’×“×•×œ)</button>
            <button class="btn" style="background-color: #e67e22; grid-column: span 2;" onclick="startMemoryGame()"><i>ğŸƒ</i> ××©×—×§ ×”×–×™×›×¨×•×Ÿ</button>
        </div>
        
        <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
            <button class="btn btn-secondary" onclick="showLeaderboard()">ğŸ† ×©×™××™×</button>
            <button class="btn btn-info" onclick="showVersions()">ğŸ“‹ ×’×¨×¡×” 8</button>
        </div>
    </div>

    <div id="screen-game" class="game-screen">
        <div id="category-title" style="margin-bottom: 10px; font-weight: bold; color: #777;"></div>
        <div id="game-content"></div>
        <div id="feedback" class="feedback"></div>
        <button class="btn btn-secondary" style="margin-top:10px" onclick="showMenu()">×™×¦×™××”</button>
    </div>

    <div id="screen-snake" class="game-screen">
        <h2 style="margin:5px 0;">ğŸ ×¡× ×™×™×§</h2>
        <div id="snake-word-target"></div>
        
        <div id="snake-container">
            <canvas id="snake-canvas" width="390" height="390"></canvas>
            
            <div id="snake-pause-overlay" class="snake-overlay">
                <h2>â¸ï¸ ××•×©×”×”</h2>
                <p>×œ×—×¦×™ ×›×“×™ ×œ×”××©×™×š</p>
            </div>

            <div id="snake-crash-overlay" class="snake-overlay">
                <h2>ğŸ’¥ × ×¤×¡×œ×ª!</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="endGame()">×¡×™×•×</button>
                    <button class="btn btn-secondary" onclick="startSnakeGame()">ğŸ”„ ×©×•×‘</button>
                </div>
            </div>
        </div>

        <div class="snake-controls">
            <button class="d-pad-btn btn-up" ontouchstart="setSnakeDir('UP', event)" onmousedown="setSnakeDir('UP', event)">â¬†ï¸</button>
            <button class="d-pad-btn btn-left" ontouchstart="setSnakeDir('LEFT', event)" onmousedown="setSnakeDir('LEFT', event)">â¬…ï¸</button>
            <div class="d-pad-center"></div>
            <button class="d-pad-btn btn-right" ontouchstart="setSnakeDir('RIGHT', event)" onmousedown="setSnakeDir('RIGHT', event)">â¡ï¸</button>
            <button class="d-pad-btn btn-down" ontouchstart="setSnakeDir('DOWN', event)" onmousedown="setSnakeDir('DOWN', event)">â¬‡ï¸</button>
        </div>
        
        <button class="btn btn-secondary" style="margin-top:10px; padding: 5px 15px; font-size:0.9rem;" onclick="stopSnakeGame()">×™×¦×™××”</button>
    </div>

    <div id="screen-memory" class="game-screen">
        <h2>ğŸƒ ××©×—×§ ×”×–×™×›×¨×•×Ÿ</h2>
        <div id="memory-board" class="memory-grid"></div>
        <button class="btn btn-secondary" style="margin-top:20px" onclick="showMenu()">×™×¦×™××”</button>
    </div>

    <div id="screen-leaderboard" class="game-screen">
        <h1>ğŸ† ××œ×•×¤×™×</h1>
        <ul id="scores-list" style="list-style: none; padding: 0; font-size:0.9rem;"></ul>
        <button class="btn btn-secondary" onclick="showMenu()">×—×–×¨×”</button>
    </div>

    <div id="screen-versions" class="game-screen">
        <h1>ğŸ“‹ ×¢×“×›×•× ×™×</h1>
        <div class="version-list" style="text-align:right;">
             <div class="version-item" style="background:#fff; padding:10px; border-radius:5px;">
                <strong>×’×¨×¡×” 8 (××•×‘×™×™×œ)</strong>
                <ul style="padding-right:20px; margin:5px 0;">
                    <li>×”×’×“×œ×ª ×”× ×—×© ×•×”××•×ª×™×•×ª ×‘-50% (×¢× ×§!)</li>
                    <li>××¡×š ××©×—×§ ×’×‘×•×” ×•××¨×•×‘×¢ ×™×•×ª×¨.</li>
                    <li>×›×¤×ª×•×¨×™ ×©×œ×™×˜×” ×¦××•×“×™× ×•× ×•×—×™× ×œ××¦×‘×¢×•×ª.</li>
                </ul>
            </div>
        </div>
        <button class="btn btn-secondary" onclick="showMenu()">×—×–×¨×”</button>
    </div>

</div>

<div id="victory-overlay" onclick="closeVictory()">
    <canvas id="fireworks-canvas"></canvas>
    <h1>ğŸ† ×›×œ ×”×›×‘×•×“! ğŸ†</h1>
    <p>×©×™× ×—×“×©!</p>
</div>

<script>
    // --- Data ---
    const vocabulary = [
        { word: "school", icon: "ğŸ«", hebrew: "×‘×™×ª ×¡×¤×¨" },
        { word: "teacher", icon: "ğŸ‘©â€ğŸ«", hebrew: "××•×¨×”" },
        { word: "pupil", icon: "ğŸ‘§", hebrew: "×ª×œ××™×“/×”" },
        { word: "friend", icon: "ğŸ‘«", hebrew: "×—×‘×¨/×”" },
        { word: "family", icon: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", hebrew: "××©×¤×—×”" },
        { word: "book", icon: "ğŸ“–", hebrew: "×¡×¤×¨" },
        { word: "notebook", icon: "ğŸ““", hebrew: "××—×‘×¨×ª" },
        { word: "pencil", icon: "âœï¸", hebrew: "×¢×™×¤×¨×•×Ÿ" },
        { word: "eraser", icon: "ğŸ§¼", hebrew: "××—×§" },
        { word: "computer", icon: "ğŸ’»", hebrew: "××—×©×‘" },
        { word: "lunch", icon: "ğŸ¥ª", hebrew: "××¨×•×—×ª ×¦×”×¨×™×™×" },
        { word: "bird", icon: "ğŸ¦", hebrew: "×¦×™×¤×•×¨" },
        { word: "house", icon: "ğŸ ", hebrew: "×‘×™×ª" },
        { word: "math", icon: "â—", hebrew: "×—×©×‘×•×Ÿ" },
        { word: "art", icon: "ğŸ¨", hebrew: "××•×× ×•×ª" },
        { word: "music", icon: "ğŸµ", hebrew: "××•×–×™×§×”" },
        { word: "sports", icon: "âš½", hebrew: "×¡×¤×•×¨×˜" },
        { word: "happy", icon: "ğŸ˜Š", hebrew: "×©××—" },
        { word: "write", icon: "âœï¸", hebrew: "×œ×›×ª×•×‘" },
        { word: "homework", icon: "ğŸ ğŸ“š", hebrew: "×©×™×¢×•×¨×™ ×‘×™×ª" },
        { word: "brother", icon: "ğŸ‘¦", hebrew: "××—" },
        { word: "sister", icon: "ğŸ‘§", hebrew: "××—×•×ª" },
        { word: "english", icon: "ğŸ”¤", hebrew: "×× ×’×œ×™×ª" },
        { word: "new", icon: "âœ¨", hebrew: "×—×“×©" }
    ];

    const sentences = [
        { text: "The _____ is on the table.", options: ["book", "fly"], answer: "book" },
        { text: "I like my _____. She is nice.", options: ["teacher", "day"], answer: "teacher" },
        { text: "We learn _____ at school.", options: ["English", "lunch"], answer: "English" },
        { text: "I have a sandwich for _____.", options: ["lunch", "pencil"], answer: "lunch" },
        { text: "This is my _____, Dan.", options: ["brother", "board"], answer: "brother" },
        { text: "Please _____ your name.", options: ["write", "happy"], answer: "write" },
        { text: "I live in a big _____.", options: ["house", "chair"], answer: "house" },
        { text: "The _____ is singing.", options: ["bird", "book"], answer: "bird" }
    ];

    const readingText = `
        Hi! My name is Gal. I am 9 years old.
        I am a pupil in grade 4.
        I learn at a big school in the town.
        My teacher is Rina. She is very nice.
        I like Math, English and Sports.
        I have a new computer at home.
    `;

    const readingQuestions = [
        { q: "What is the girl's name?", options: ["Rina", "Gal", "Tal"], answer: "Gal" },
        { q: "What grade is she in?", options: ["Grade 3", "Grade 5", "Grade 4"], answer: "Grade 4" },
        { q: "What is the teacher's name?", options: ["Rina", "Gal", "Dana"], answer: "Rina" },
        { q: "What does she have at home?", options: ["A bird", "A new computer", "A dog"], answer: "A new computer" }
    ];

    let score = 0;
    let currentMode = '';
    let currentQuestionIndex = 0;
    let currentData = [];
    let currentQuestionHints = 0;

    // Audio
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); }
    
    function playFailSound() {
        initAudio();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine'; 
        o.frequency.setValueAtTime(200, audioCtx.currentTime);
        o.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.5); 
        g.gain.setValueAtTime(0.3, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start();
        o.stop(audioCtx.currentTime + 0.5);
    }

    function playFanfare() {
        initAudio();
        [523, 523, 523, 659, 523, 783].forEach((f, i) => {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = 'square'; o.frequency.value = f;
            o.connect(g); g.connect(audioCtx.destination);
            o.start(audioCtx.currentTime + i*0.2); 
            g.gain.setValueAtTime(0.1, audioCtx.currentTime + i*0.2);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i*0.2 + 0.2);
            o.stop(audioCtx.currentTime + i*0.2 + 0.2);
        });
    }

    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US'; u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }
    }

    function switchScreen(id) {
        document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id !== 'screen-snake') snakeGame.running = false;
    }

    function updateScoreDisplay() { document.getElementById('currentScore').innerText = score; }
    function showMenu() { switchScreen('screen-menu'); }
    function showVersions() { switchScreen('screen-versions'); }

    // --- Standard Games ---
    function startGame(mode) {
        currentMode = mode;
        score = 0;
        currentQuestionIndex = 0;
        updateScoreDisplay();
        switchScreen('screen-game');
        
        const titles = {
            listening: "×”×§×©×™×‘×™ ×•×œ×—×¦×™ ×¢×œ ×”×ª××•× ×” ×”× ×›×•× ×”",
            vocab: "×›×ª×‘×™ ××ª ×”××™×œ×” ×‘×× ×’×œ×™×ª",
            sentences: "×”×©×œ×™××™ ××ª ×”××©×¤×˜",
            reading: "×§×¨××™ ××ª ×”×˜×§×¡×˜ ×•×¢× ×™ ×¢×œ ×”×©××œ×•×ª"
        };
        document.getElementById('category-title').innerText = titles[mode];
        generateLevelData();
        renderQuestion();
    }

    function restartCurrentGame() {
        if (currentMode === 'snake') startSnakeGame();
        else if (currentMode === 'memory') startMemoryGame();
        else startGame(currentMode);
    }

    function generateLevelData() {
        if (currentMode === 'listening' || currentMode === 'vocab') currentData = [...vocabulary].sort(() => 0.5 - Math.random()).slice(0, 10);
        else if (currentMode === 'sentences') currentData = [...sentences].sort(() => 0.5 - Math.random()).slice(0, 8);
        else if (currentMode === 'reading') currentData = [...readingQuestions];
    }

    function renderQuestion() {
        const container = document.getElementById('game-content');
        const feedback = document.getElementById('feedback');
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn';
        nextBtn.innerText = '×”×‘×';
        nextBtn.id = 'next-btn';
        nextBtn.style.display = 'none';
        nextBtn.style.marginTop = '10px';
        nextBtn.onclick = nextQuestion;
        
        container.innerHTML = '';
        feedback.innerText = '';
        feedback.className = 'feedback';
        currentQuestionHints = 0;

        if (currentQuestionIndex >= currentData.length) { endGame(); return; }

        const item = currentData[currentQuestionIndex];

        // Listening
        if (currentMode === 'listening') {
            let options = [item];
            while(options.length < 3) {
                let r = vocabulary[Math.floor(Math.random() * vocabulary.length)];
                if (!options.includes(r)) options.push(r);
            }
            options.sort(() => 0.5 - Math.random());
            
            const btnSpeak = document.createElement('button');
            btnSpeak.className = 'btn btn-secondary';
            btnSpeak.innerText = 'ğŸ”Š ×”×©××™×¢×™ ××™×œ×”';
            btnSpeak.onclick = () => speak(item.word);
            setTimeout(() => speak(item.word), 500);

            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'word-options';
            optionsDiv.style.display = 'flex'; optionsDiv.style.justifyContent = 'center'; optionsDiv.style.gap = '15px'; optionsDiv.style.marginTop = '20px';
            
            options.forEach(opt => {
                const b = document.createElement('div');
                b.style.fontSize = '3rem'; b.style.cursor = 'pointer'; b.style.padding = '10px'; b.style.border = '2px solid #eee'; b.style.borderRadius = '10px';
                b.innerText = opt.icon;
                b.onclick = () => checkAnswer(opt.word, item.word);
                optionsDiv.appendChild(b);
            });
            container.appendChild(btnSpeak);
            container.appendChild(optionsDiv);
        }

        // Vocabulary
        if (currentMode === 'vocab') {
            const icon = document.createElement('div');
            icon.style.fontSize = '4rem';
            icon.innerText = item.icon;
            
            const hint = document.createElement('div');
            hint.innerText = item.hebrew;
            hint.style.fontSize = "1.2rem"; hint.style.marginBottom = "10px";

            const inputWrapper = document.createElement('div');
            inputWrapper.style.display = 'flex';
            inputWrapper.style.justifyContent = 'center';
            inputWrapper.style.alignItems = 'center';
            inputWrapper.style.flexDirection = 'column';
            inputWrapper.style.gap = '10px';

            const input = document.createElement('input');
            input.type = 'text'; input.className = 'input-box';
            input.autocomplete = "off";
            input.onkeypress = (e) => { if(e.key === 'Enter') checkAnswer(input.value, item.word); };

            const hintBtn = document.createElement('button');
            const maxHints = Math.floor(item.word.length / 2);
            hintBtn.className = 'btn btn-hint';
            hintBtn.innerText = `ğŸ’¡ ×¨××– (0/${maxHints})`;
            if (maxHints === 0) hintBtn.disabled = true;

            hintBtn.onclick = () => {
                if (currentQuestionHints >= maxHints) return;
                currentQuestionHints++;
                hintBtn.innerText = `ğŸ’¡ ×¨××– (${currentQuestionHints}/${maxHints})`;
                if (currentQuestionHints >= maxHints) hintBtn.disabled = true;
                let currentVal = input.value.toLowerCase();
                let target = item.word.toLowerCase();
                for(let i=0; i<target.length; i++) {
                    if (currentVal[i] !== target[i]) {
                        input.value = target.substring(0, i+1);
                        break;
                    }
                }
                input.focus();
            };

            const checkBtn = document.createElement('button');
            checkBtn.className = 'btn';
            checkBtn.style.marginTop = '10px';
            checkBtn.innerText = '×‘×“×™×§×”';
            checkBtn.onclick = () => checkAnswer(input.value, item.word);

            container.appendChild(icon);
            container.appendChild(hint);
            inputWrapper.appendChild(input);
            inputWrapper.appendChild(hintBtn);
            container.appendChild(inputWrapper);
            container.appendChild(checkBtn);
            setTimeout(() => input.focus(), 100);
        }

        // Sentences & Reading
        if (currentMode === 'sentences' || currentMode === 'reading') {
            if (currentMode === 'reading') {
                const textDiv = document.createElement('div');
                textDiv.className = 'reading-text';
                textDiv.style.textAlign = 'left'; textDiv.style.background = 'white'; textDiv.style.padding = '10px'; textDiv.style.borderLeft = '4px solid var(--primary)';
                textDiv.innerText = readingText;
                container.appendChild(textDiv);
            }
            
            const qDiv = document.createElement('div');
            qDiv.style.fontSize = "1.2rem";
            qDiv.style.marginBottom = "20px";
            qDiv.style.direction = "ltr";
            qDiv.innerHTML = currentMode === 'sentences' ? item.text : `<h3>${item.q}</h3>`;

            const optionsDiv = document.createElement('div');
            optionsDiv.style.display = 'flex'; optionsDiv.style.gap = '10px'; optionsDiv.style.justifyContent = 'center';
            item.options.forEach(opt => {
                const b = document.createElement('button');
                b.className = 'btn btn-secondary';
                b.innerText = opt;
                b.onclick = () => checkAnswer(opt, item.answer);
                optionsDiv.appendChild(b);
            });
            container.appendChild(qDiv);
            container.appendChild(optionsDiv);
        }
        
        container.appendChild(nextBtn);
    }

    function checkAnswer(userAnswer, correctAnswer) {
        if (document.getElementById('next-btn').style.display === 'inline-block') return;
        const feedback = document.getElementById('feedback');
        
        if (userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase()) {
            let points = 10;
            if (currentMode === 'vocab' && currentQuestionHints > 0) {
                const wordLength = correctAnswer.length;
                const deduction = (currentQuestionHints / wordLength) * 10;
                points = Math.round(10 - deduction);
                feedback.innerText = `× ×›×•×Ÿ! (${points} × ×§')`;
            } else {
                feedback.innerText = "Excellent! ×›×œ ×”×›×‘×•×“! (10 × ×§')";
            }

            feedback.className = "feedback correct";
            score += points;
            speak("Good job!");
        } else {
            feedback.innerText = `×”×ª×©×•×‘×”: ${correctAnswer}`;
            feedback.className = "feedback wrong";
            speak("Try again");
        }
        updateScoreDisplay();
        document.getElementById('next-btn').style.display = 'inline-block';
    }

    function nextQuestion() {
        currentQuestionIndex++;
        renderQuestion();
    }

    // --- SNAKE GAME (UPDATED SIZE) ---
    const snakeGame = {
        canvas: null, ctx: null, 
        grid: 30, // ×’×•×“×œ ××©×‘×¦×ª ×”×•×’×“×œ ×-20 ×œ-30 (50% ×™×•×ª×¨)
        running: false, paused: false, crashed: false,
        snake: [], items: [],
        dx: 0, dy: 0,
        wordData: null, targetWord: "", currentLetterIndex: 0,
        loopId: null, speed: 220 
    };

    function startSnakeGame() {
        currentMode = 'snake';
        score = 0;
        updateScoreDisplay();
        switchScreen('screen-snake');
        
        snakeGame.canvas = document.getElementById('snake-canvas');
        snakeGame.ctx = snakeGame.canvas.getContext('2d');
        // ×”×’×“×¨×” ××—×“×© ×©×œ ×”×’×¨×™×“ ×œ×™×ª×¨ ×‘×™×˜×—×•×Ÿ
        snakeGame.grid = 30; 
        snakeGame.running = true;
        snakeGame.paused = false;
        snakeGame.crashed = false;
        document.getElementById('snake-crash-overlay').style.display = 'none';
        document.getElementById('snake-pause-overlay').style.display = 'none';

        nextSnakeLevel();
        document.addEventListener('keydown', handleSnakeKey);
        
        if (snakeGame.loopId) clearInterval(snakeGame.loopId);
        snakeGame.loopId = setInterval(gameLoop, snakeGame.speed);
    }

    function stopSnakeGame() {
        snakeGame.running = false;
        clearInterval(snakeGame.loopId);
        document.removeEventListener('keydown', handleSnakeKey);
        endGame();
    }
    
    function freezeSnakeGame() {
        snakeGame.crashed = true;
        document.getElementById('snake-crash-overlay').style.display = 'flex';
        playFailSound();
    }

    function nextSnakeLevel() {
        snakeGame.wordData = vocabulary[Math.floor(Math.random() * vocabulary.length)];
        snakeGame.targetWord = snakeGame.wordData.word.toUpperCase();
        snakeGame.currentLetterIndex = 0;
        
        // ××™×§×•× ×”×ª×—×œ×ª×™ ××•×ª×× ×œ×’×¨×™×“ ×”×—×“×©
        snakeGame.snake = [{x: 150, y: 150}, {x: 120, y: 150}, {x: 90, y: 150}];
        snakeGame.dx = snakeGame.grid; snakeGame.dy = 0;
        spawnSnakeItems();
        updateSnakeUI();
    }

    function updateSnakeUI() {
        const display = document.getElementById('snake-word-target');
        display.innerHTML = `<div style="font-size:1rem; color:#888;">${snakeGame.wordData.hebrew}</div>`;
        const wordContainer = document.createElement('div');
        for (let i = 0; i < snakeGame.targetWord.length; i++) {
            const span = document.createElement('span');
            span.innerText = snakeGame.targetWord[i];
            span.className = i < snakeGame.currentLetterIndex ? 'found-letter' : 'missing-letter';
            span.style.color = i < snakeGame.currentLetterIndex ? '#7ed321' : '#ccc';
            span.style.borderBottom = i < snakeGame.currentLetterIndex ? '2px solid #7ed321' : '2px solid #ccc';
            if (i >= snakeGame.currentLetterIndex) span.innerText = '_';
            span.style.margin = "0 5px";
            wordContainer.appendChild(span);
        }
        display.appendChild(wordContainer);
    }

    function spawnSnakeItems() {
        snakeGame.items = [];
        const correctChar = snakeGame.targetWord[snakeGame.currentLetterIndex];
        // ×—×™×©×•×‘ ×’×‘×•×œ×•×ª ×œ×¤×™ ×’×•×“×œ ×”×§× ×‘×¡ ×”×—×“×© (390 / 30 = 13 ×ª××™×)
        const maxCells = snakeGame.canvas.width / snakeGame.grid; // 13
        
        snakeGame.items.push({ 
            x: getRandomInt(0, maxCells)*snakeGame.grid, 
            y: getRandomInt(0, maxCells)*snakeGame.grid, 
            char: correctChar, type: 'correct' 
        });
        
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let wrongChar;
        do { wrongChar = alphabet[Math.floor(Math.random() * alphabet.length)]; } while(wrongChar === correctChar);
        
        snakeGame.items.push({ 
            x: getRandomInt(0, maxCells)*snakeGame.grid, 
            y: getRandomInt(0, maxCells)*snakeGame.grid, 
            char: wrongChar, type: 'wrong' 
        });
    }

    function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min)) + min; }

    function handleSnakeKey(e) {
        if (snakeGame.crashed) return;
        if (e.key === 'Escape') {
            snakeGame.paused = !snakeGame.paused;
            document.getElementById('snake-pause-overlay').style.display = snakeGame.paused ? 'flex' : 'none';
            return;
        }
        if (snakeGame.paused) {
            snakeGame.paused = false;
            document.getElementById('snake-pause-overlay').style.display = 'none';
            return;
        }

        const goingUp = snakeGame.dy === -snakeGame.grid;
        const goingDown = snakeGame.dy === snakeGame.grid;
        const goingRight = snakeGame.dx === snakeGame.grid;
        const goingLeft = snakeGame.dx === -snakeGame.grid;

        if (e.keyCode === 37 && !goingRight) { snakeGame.dx = -snakeGame.grid; snakeGame.dy = 0; }
        if (e.keyCode === 38 && !goingDown) { snakeGame.dx = 0; snakeGame.dy = -snakeGame.grid; }
        if (e.keyCode === 39 && !goingLeft) { snakeGame.dx = snakeGame.grid; snakeGame.dy = 0; }
        if (e.keyCode === 40 && !goingUp) { snakeGame.dx = 0; snakeGame.dy = snakeGame.grid; }
    }

    function setSnakeDir(dir, e) {
        if(e) e.preventDefault(); // ×× ×™×¢×ª ×–×•× ×›×¤×•×œ ×‘××•×‘×™×™×œ
        if (snakeGame.paused || snakeGame.crashed) return;
        const keyMap = { 'LEFT': 37, 'UP': 38, 'RIGHT': 39, 'DOWN': 40 };
        const eventSim = { keyCode: keyMap[dir], preventDefault: ()=>{} };
        handleSnakeKey(eventSim);
    }

    function gameLoop() {
        if (!snakeGame.running || snakeGame.paused || snakeGame.crashed) return;

        const head = { x: snakeGame.snake[0].x + snakeGame.dx, y: snakeGame.snake[0].y + snakeGame.dy };
        
        if (head.x < 0 || head.x >= snakeGame.canvas.width || head.y < 0 || head.y >= snakeGame.canvas.height) {
            freezeSnakeGame(); return;
        }
        for (let i = 0; i < snakeGame.snake.length; i++) {
            if (head.x === snakeGame.snake[i].x && head.y === snakeGame.snake[i].y) {
                freezeSnakeGame(); return;
            }
        }

        snakeGame.snake.unshift(head);

        let ate = false;
        for (let i = 0; i < snakeGame.items.length; i++) {
            let item = snakeGame.items[i];
            if (head.x === item.x && head.y === item.y) {
                if (item.type === 'correct') {
                    score += 5; updateScoreDisplay();
                    snakeGame.currentLetterIndex++;
                    ate = true;
                    if (snakeGame.currentLetterIndex >= snakeGame.targetWord.length) {
                        score += 20; updateScoreDisplay(); speak(snakeGame.wordData.word);
                        nextSnakeLevel(); return;
                    } else { spawnSnakeItems(); updateSnakeUI(); }
                } else {
                    score = Math.max(0, score - 2); updateScoreDisplay();
                    snakeGame.items.splice(i, 1); snakeGame.snake.pop(); 
                }
                break;
            }
        }
        if (!ate) snakeGame.snake.pop();

        // ×¦×™×•×¨
        const ctx = snakeGame.ctx;
        const g = snakeGame.grid; // 30
        
        ctx.fillStyle = '#2c3e50'; ctx.fillRect(0, 0, snakeGame.canvas.width, snakeGame.canvas.height);

        // ×¦×™×•×¨ ×¤×¨×™×˜×™× ××•×ª×× ×œ×’×•×“×œ ×”×—×“×© (24px ×¤×•× ×˜, ×××•×¨×›×– ×‘-30px)
        ctx.font = "bold 22px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        snakeGame.items.forEach(item => {
            ctx.fillStyle = item.type === 'correct' ? '#2ecc71' : '#e74c3c';
            ctx.beginPath(); 
            // ××¨×›×– ×”×¢×™×’×•×œ ×”×•× X + ×—×¦×™ ×’×¨×™×“ (15)
            ctx.arc(item.x + g/2, item.y + g/2, g/2 - 2, 0, 2 * Math.PI); 
            ctx.fill();
            ctx.fillStyle = 'white'; 
            ctx.fillText(item.char, item.x + g/2, item.y + g/2 + 1);
        });

        // ×¦×™×•×¨ ×”× ×—×©
        snakeGame.snake.forEach((part, index) => {
            if (index === 0) {
                ctx.fillStyle = '#3498db';
                // ×¨××© ×”× ×—×© ×§×¦×ª ×§×˜×Ÿ ××”×’×¨×™×“ ×›×“×™ ×©×™×”×™×” ×¨×•×•×—
                ctx.fillRect(part.x + 1, part.y + 1, g - 2, g - 2);
                
                // ×¢×™× ×™×™× ××•×ª×××•×ª ×œ×’×•×“×œ 30
                ctx.fillStyle = 'white';
                let ex1, ey1, ex2, ey2;
                // ×—×™×©×•×‘ ×™×—×¡×™: ×‘-20 ×–×” ×”×™×” 4 ×•-12. ×‘-30 ×–×” ×™×”×™×” 6 ×•-18 (×‘×¢×¨×š)
                const s = 6; const l = 20; 
                
                if (snakeGame.dx > 0) { ex1=l; ey1=s; ex2=l; ey2=30-s; } 
                else if (snakeGame.dx < 0) { ex1=s; ey1=s; ex2=s; ey2=30-s; }
                else if (snakeGame.dy < 0) { ex1=s; ey1=s; ex2=30-s; ey2=s; }
                else { ex1=s; ey1=l; ex2=30-s; ey2=l; }
                
                ctx.beginPath(); ctx.arc(part.x+ex1, part.y+ey1, 4, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(part.x+ex2, part.y+ey2, 4, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'black';
                ctx.beginPath(); ctx.arc(part.x+ex1, part.y+ey1, 1.5, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(part.x+ex2, part.y+ey2, 1.5, 0, Math.PI*2); ctx.fill();
            } else {
                ctx.fillStyle = '#5dade2';
                ctx.fillRect(part.x + 1, part.y + 1, g - 2, g - 2);
            }
        });
    }

    // --- MEMORY GAME ---
    let memoryState = { cards: [], flipped: [], matches: 0 };
    function startMemoryGame() {
        currentMode = 'memory'; score = 0; updateScoreDisplay(); switchScreen('screen-memory');
        let selected = [...vocabulary].sort(() => 0.5 - Math.random()).slice(0, 6);
        let deck = [];
        selected.forEach(item => {
            deck.push({ id: item.word, content: item.hebrew + "<br><span style='font-size:1.5rem'>" + item.icon + "</span>" });
            deck.push({ id: item.word, content: item.word });
        });
        deck.sort(() => 0.5 - Math.random());
        
        const board = document.getElementById('memory-board');
        board.innerHTML = '';
        memoryState = { cards: deck, flipped: [], matches: 0 };
        
        deck.forEach((card, index) => {
            const cardEl = document.createElement('div');
            cardEl.className = 'memory-card';
            cardEl.onclick = () => flipCard(index, cardEl, card);
            cardEl.innerHTML = `<div class="memory-card-front">?</div><div class="memory-card-content">${card.content}</div>`;
            board.appendChild(cardEl);
        });
    }

    function flipCard(index, el, card) {
        if (el.classList.contains('flipped') || memoryState.flipped.length >= 2) return;
        el.classList.add('flipped');
        memoryState.flipped.push({ index, id: card.id });
        if (memoryState.flipped.length === 2) checkMemoryMatch();
    }

    function checkMemoryMatch() {
        const [c1, c2] = memoryState.flipped;
        const els = document.getElementById('memory-board').children;
        if (c1.id === c2.id) {
            score += 15; updateScoreDisplay(); speak("Good!");
            memoryState.flipped = []; memoryState.matches++;
            if (memoryState.matches === 6) setTimeout(endGame, 1000);
        } else {
            setTimeout(() => {
                els[c1.index].classList.remove('flipped');
                els[c2.index].classList.remove('flipped');
                memoryState.flipped = [];
            }, 1000);
        }
    }

    // --- End & Leaderboard ---
    function endGame() {
        const isNewRecord = checkHighScore(score);
        switchScreen('screen-game');
        
        const gameContent = document.getElementById('game-content');
        gameContent.innerHTML = `
            <h2>×¡×™×™××ª!</h2>
            <div style="font-size:3rem">ğŸ†</div>
            <h3>× ×™×§×•×“: ${score}</h3>
            <input type="text" id="playerName" class="input-box" placeholder="×©××š..." style="width:180px">
            <br>
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="saveToLeaderboard()">ğŸ’¾ ×©××™×¨×”</button>
                <button class="btn" onclick="restartCurrentGame()">ğŸ”„ ×©×•×‘</button>
            </div>
        `;
        document.getElementById('next-btn').style.display = 'none';
        if (isNewRecord) celebrateNewRecord();
    }

    function checkHighScore(s) {
        if (s === 0) return false;
        const saved = JSON.parse(localStorage.getItem('englishGameScores')) || [];
        const modeScores = saved.filter(x => x.mode === currentMode);
        if (modeScores.length === 0) return true;
        return s > Math.max(...modeScores.map(x => x.score));
    }

    function celebrateNewRecord() {
        document.getElementById('victory-overlay').style.display = 'flex';
        initAudio(); playFanfare(); startFireworks();
    }
    function closeVictory() { document.getElementById('victory-overlay').style.display = 'none'; stopFireworks(); }

    function saveToLeaderboard() {
        const name = document.getElementById('playerName').value || "Anonymous";
        let scores = JSON.parse(localStorage.getItem('englishGameScores')) || [];
        scores.push({ name, score, date: new Date().toLocaleDateString('he-IL'), mode: currentMode });
        scores.sort((a, b) => b.score - a.score);
        localStorage.setItem('englishGameScores', JSON.stringify(scores));
        showLeaderboard();
    }

    function showLeaderboard() {
        switchScreen('screen-leaderboard');
        const list = document.getElementById('scores-list');
        list.innerHTML = '';
        let scores = JSON.parse(localStorage.getItem('englishGameScores')) || [];
        if (!scores.length) { list.innerHTML = '<li>××™×Ÿ ×ª×•×¦××•×ª...</li>'; return; }
        scores.slice(0, 10).forEach((s, i) => {
            const icons = { listening: 'ğŸ‘‚', vocab: 'âœï¸', snake: 'ğŸ', memory: 'ğŸƒ', sentences: 'ğŸ§©', reading: 'ğŸ“–' };
            list.innerHTML += `<li style="padding:8px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between;">
                <span>#${i+1} <strong>${s.name}</strong></span>
                <span>${s.score} ${icons[s.mode] || ''}</span>
            </li>`;
        });
    }

    let fwLoop; const fwC = document.getElementById('fireworks-canvas'); const fwCtx = fwC.getContext('2d');
    let parts = [];
    window.addEventListener('resize', () => { fwC.width = window.innerWidth; fwC.height = window.innerHeight; });
    
    function startFireworks() {
        fwC.width = window.innerWidth; fwC.height = window.innerHeight;
        parts = []; loopFW();
    }
    function loopFW() {
        fwCtx.globalCompositeOperation = 'destination-out';
        fwCtx.fillStyle = 'rgba(0,0,0,0.1)'; fwCtx.fillRect(0,0,fwC.width, fwC.height);
        fwCtx.globalCompositeOperation = 'lighter';
        parts.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.a -= 0.02;
            fwCtx.fillStyle = p.c; fwCtx.globalAlpha = p.a;
            fwCtx.beginPath(); fwCtx.arc(p.x, p.y, 3, 0, 6.28); fwCtx.fill();
            if (p.a <= 0) parts.splice(i, 1);
        });
        if (Math.random() < 0.05) {
            for(let i=0; i<30; i++) parts.push({
                x: Math.random()*fwC.width, y: Math.random()*fwC.height/2,
                vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                a: 1, c: `hsl(${Math.random()*360}, 100%, 50%)`
            });
        }
        fwLoop = requestAnimationFrame(loopFW);
    }
    function stopFireworks() { cancelAnimationFrame(fwLoop); fwCtx.clearRect(0,0,fwC.width, fwC.height); }

</script>
</body>
</html>
